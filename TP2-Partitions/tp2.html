<html>
<head>
  <meta charset="UTF-8"/>
  <title>Dessin SVG avec d3.js</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
</head>
<body>
  <svg xmlns="http://www.w3.org/2000/svg" id="dessin"></svg>

  <script type="module">

// voir https://stackoverflow.com/a/65056488 (append if not exist)
d3.selection.prototype.appendIfAbsent = function(selector, type) {
  const element = this.select(selector)
  return element.empty() ? this.append(type) : element
}

const Trapezes = [
    { id: 0, supL: 5, corL: 11, corH: 14, supH: 18, nom: "froid" },
    { id: 1, supL: 14, corL: 18, corH: 20, supH: 22, nom: "frais" },
    { id: 2, supL: 20, corL: 22, corH: 24, supH: 30, nom: "tiède" },
    { id: 3, supL: 24, corL: 30, corH: 38, supH: 42, nom: "chaud" },
]

const Trapezes2 = [
    { id: -1, supL: 0, corL: 0, corH: 5, supH: 11, nom: "glacial" },
    ...Trapezes, // ajout ici des éléments de Trapezes
    { id: 4, supL: 38, corL: 42, corH: 60, supH: 80, nom: "brûlant" },
]

const svg = d3.select("#dessin")


function PartitionFloue(trapezes, transform=null) {
    console.log("TRAPEZES", trapezes)

    const N = trapezes.length
    const width = 600
    const height = width / 4
    const margin = {top: 20, right: 10, bottom: 20, left: 10}

    let fX = d3.scaleLinear()
      .domain([ trapezes[0].supL - 1, trapezes[N-1].supH + 1 ])
      .range([margin.left, width - margin.right])
    if (transform != null){fX = transform.rescaleX(fX)}
    const fY = d3.scaleLinear()
      .domain([ 0, 1])
      .range([height - margin.bottom, margin.top])

    const bottom = fY(0)
    const top = fY(1)

    const couleurs = d3.schemeSet2
    const fColor = d3.scaleOrdinal()
      .domain(d3.range(N))   
      .range(couleurs)

    svg
      .attr("width", width)
      .attr("height", height)
      .attr("viewBox", `0 0 ${width} ${height}`)
      .attr("preserveAspectRatio", "xMidYMid meet")

  svg.append("g")
  .attr("transform", `translate(0, ${bottom})`)
  .call(d3.axisBottom(fX))

  svg.append("g")
    .attr("transform", `translate(0, ${top})`)
    .call(d3.axisTop(fX))

  const grpTrapezes = svg.append("g")

  /*grpTrapezes.selectAll("path")
    .data(trapezes)
    .enter()
    .append("path")
    .attr("d", d => `M ${fX(d.supL)} ${fY(0)}L ${fX(d.corL)} ${fY(1)}L ${fX(d.corH)} ${fY(1)}L ${fX(d.supH)} ${fY(0)}Z`)
    .attr("stroke", d => fColor(d.id))
    .attr("stroke-width", 2)
    .attr("fill",  d => fColor(d.id))
    .attr("fill-opacity", 0.4)*/


grpTrapezes
    .selectAll("g")
    .data(trapezes)
    .join(
        enter => {
            const g = enter.appendIfAbsent("#idEE", "g").attr("id", "idEE")
            g.append("path")
            .attr("d", d => `M ${fX(d.supL)} ${fY(0)}L ${fX(d.corL)} ${fY(1)}L ${fX(d.corH)} ${fY(1)}L ${fX(d.supH)} ${fY(0)}Z`)
            .attr("stroke", d => fColor(d.id))
            .attr("stroke-width", 2)
            .attr("fill",  d => fColor(d.id))
            .attr("fill-opacity", 0.4)

          g.append("text")
                .text(trp => trp.nom)
                .attr("x", d => fX(d.corL))
                .attr("y", d => fY(1)+fY(0)/2)
        },

        update => {
            const g = enter.appendIfAbsent("#idEE", "g").attr("id", "idEE")
            update.select("path")
                .attr("d", d => `M ${fX(d.supL)} ${fY(0)}L ${fX(d.corL)} ${fY(1)}L ${fX(d.corH)} ${fY(1)}L ${fX(d.supH)} ${fY(0)}Z`)
                .attr("stroke", d => fColor(d.id))
                .attr("stroke-width", 2)
                .attr("fill",  d => fColor(d.id))
                .attr("fill-opacity", 0.4)

            update.select("text")
                .text(trp => trp.nom)
                .attr("x", d => fX(d.corL))
                .attr("y", d => fY(1) + fY(0) / 2)
        }
    )

}
const zoom = d3.zoom()
  .extent([[0, 0], [600, 150]])
  .scaleExtent([0.25, 64])
  .on("zoom", (event) => {
    PartitionFloue(Trapezes2, event.transform)
  .attr("fill-opacity", 0.4)
  })

svg.call(zoom)

PartitionFloue(Trapezes2)
  </script>
</body>
</html>